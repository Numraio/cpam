# AlertManager Configuration
# Routes alerts to appropriate notification channels based on severity and service

global:
  # Global settings
  resolve_timeout: 5m

  # Slack configuration (requires SLACK_API_URL)
  slack_api_url: ${SLACK_API_URL}

  # PagerDuty configuration (requires PAGERDUTY_SERVICE_KEY)
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# Route tree for alert routing
route:
  # Default receiver for all alerts
  receiver: 'team-notifications'

  # Group alerts by common labels
  group_by: ['alertname', 'service', 'severity']

  # Wait before sending initial notification
  group_wait: 30s

  # Wait before sending notification about new alerts added to group
  group_interval: 5m

  # Wait before re-sending notification for ongoing alerts
  repeat_interval: 4h

  # Child routes for specific alert types
  routes:
    # Critical alerts to PagerDuty + Slack
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true

      # Service-specific critical routing
      routes:
        - match:
            service: api
          receiver: 'api-team-critical'

        - match:
            service: calculation
          receiver: 'calc-team-critical'

        - match:
            service: ingestion
          receiver: 'data-team-critical'

    # Warning alerts to Slack only
    - match:
        severity: warning
      receiver: 'team-warnings'
      group_wait: 2m
      repeat_interval: 12h

    # Info alerts to Slack (low priority)
    - match:
        severity: info
      receiver: 'team-info'
      group_wait: 10m
      repeat_interval: 24h

    # Platform health alerts
    - match:
        alertname: ServiceDown
      receiver: 'pagerduty-critical'
      group_wait: 0s

    # Data quality alerts to data team
    - match_re:
        alertname: '(DataQuality|IngestionLag|IngestionFailure).*'
      receiver: 'data-team'

    # Queue alerts to operations team
    - match_re:
        alertname: '(QueueDepth|QueueProcessing).*'
      receiver: 'ops-team'

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # Inhibit warning if critical alert is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # Inhibit info if warning/critical is firing
  - source_match_re:
      severity: 'critical|warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'service']

  # Inhibit specific alerts when service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(API|Calc|Queue|Ingestion).*'
    equal: ['service']

# Receiver definitions
receivers:
  # Default team notifications (Slack)
  - name: 'team-notifications'
    slack_configs:
      - channel: '#cpam-alerts'
        title: 'CPAM Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Severity:* {{ .GroupLabels.severity }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        send_resolved: true

  # PagerDuty for critical alerts
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: ${PAGERDUTY_SERVICE_KEY}
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        details:
          service: '{{ .GroupLabels.service }}'
          severity: '{{ .GroupLabels.severity }}'
          description: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
          runbook: '{{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}'
        client: 'CPAM AlertManager'
        client_url: '{{ .ExternalURL }}'

    # Also send to Slack
    slack_configs:
      - channel: '#cpam-incidents'
        title: ':fire: CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          *Runbook:* {{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}
        color: 'danger'
        send_resolved: true

  # API team critical alerts
  - name: 'api-team-critical'
    slack_configs:
      - channel: '#api-team-alerts'
        title: ':fire: API Critical: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          *Runbook:* {{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}
        color: 'danger'
        send_resolved: true

  # Calculation team critical alerts
  - name: 'calc-team-critical'
    slack_configs:
      - channel: '#calc-team-alerts'
        title: ':fire: Calculation Critical: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          *Runbook:* {{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}
        color: 'danger'
        send_resolved: true

  # Data team critical alerts
  - name: 'data-team-critical'
    slack_configs:
      - channel: '#data-team-alerts'
        title: ':fire: Data/Ingestion Critical: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          *Runbook:* {{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}
        color: 'danger'
        send_resolved: true

  # Warning alerts
  - name: 'team-warnings'
    slack_configs:
      - channel: '#cpam-alerts'
        title: ':warning: Warning: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'warning'
        send_resolved: true

  # Info alerts
  - name: 'team-info'
    slack_configs:
      - channel: '#cpam-alerts'
        title: ':information_source: Info: {{ .GroupLabels.alertname }}'
        text: |
          *Service:* {{ .GroupLabels.service }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        color: 'good'
        send_resolved: true

  # Data team
  - name: 'data-team'
    slack_configs:
      - channel: '#data-team-alerts'
        title: 'Data Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Severity:* {{ .GroupLabels.severity }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        send_resolved: true

  # Operations team
  - name: 'ops-team'
    slack_configs:
      - channel: '#ops-team-alerts'
        title: 'Ops Alert: {{ .GroupLabels.alertname }}'
        text: |
          *Severity:* {{ .GroupLabels.severity }}
          *Summary:* {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
          *Description:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
        send_resolved: true

# Templates for custom message formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
